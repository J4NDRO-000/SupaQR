<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR File Tracker - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-link {
            color: #667eea;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: inline-block;
        }

        .nav-link:hover {
            background: #667eea;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
            font-size: 1.1em;
        }

        .uploads-table {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .table-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
        }

        .table-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        .upload-row:hover {
            background: #f8f9ff;
        }

        .upload-id {
            font-family: monospace;
            background: #f1f1f1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .file-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
        }

        .access-count {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .date-cell {
            color: #666;
            font-size: 0.9em;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .view-btn {
            background: #17a2b8;
            color: white;
        }

        .view-btn:hover {
            background: #138496;
        }

        .qr-btn {
            background: #6c757d;
            color: white;
        }

        .qr-btn:hover {
            background: #545b62;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .size-cell {
            color: #666;
            font-size: 0.9em;
        }

        .country-distribution, .device-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .distribution-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .distribution-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .distribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .distribution-item:last-child {
            border-bottom: none;
        }

        .distribution-label {
            font-weight: 500;
            color: #333;
        }

        .distribution-value {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .stat-number {
                font-size: 2.5em;
            }

            .table-container {
                overflow-x: scroll;
            }

            .actions {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>📊 Dashboard Analytics</h1>
            <p>Estadísticas completas de tus archivos compartidos y QR codes</p>
        </div>

        <div class="nav-links">
            <a href="/index.html" class="nav-link">📤 Subir Archivos</a>
            <a href="/dashboard.html" class="nav-link">📊 Dashboard</a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            <!-- Estadísticas Generales -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Distribuciones -->
            <div class="country-distribution" id="distributionContainer"></div>

            <!-- Gráfico de Accesos Diarios -->
            <div class="chart-container">
                <div class="chart-title">📈 Accesos por Día (Últimos 30 días)</div>
                <div class="chart-wrapper">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <!-- Tabla de Uploads -->
            <div class="uploads-table">
                <div class="table-header">
                    <div class="table-title">📁 Todos los Uploads</div>
                    <button class="export-btn" onclick="exportData()">📊 Exportar CSV</button>
                    <button class="refresh-btn" onclick="loadDashboardData()">🔄 Actualizar</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID Upload</th>
                                <th>Archivos</th>
                                <th>Tamaño Total</th>
                                <th>Creado</th>
                                <th>Accesos</th>
                                <th>Visitantes Únicos</th>
                                <th>Último Acceso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="uploadsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">📭</div>
            <h3>No hay datos aún</h3>
            <p>Sube algunos archivos para empezar a ver estadísticas</p>
            <a href="/index.html" class="nav-link" style="margin-top: 20px;">📤 Subir Primer Archivo</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let dashboardData = null;
        let dailyChart = null;

        // Cargar datos del dashboard al inicio
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
        });

        async function loadDashboardData() {
            try {
                document.getElementById('loadingState').style.display = 'flex';
                document.getElementById('dashboardContent').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';

                const response = await fetch('/api/dashboard');
                if (!response.ok) {
                    throw new Error('Error cargando datos');
                }

                dashboardData = await response.json();
                
                if (dashboardData.uploads.length === 0) {
                    showEmptyState();
                } else {
                    renderDashboard(dashboardData);
                }

            } catch (error) {
                console.error('Error:', error);
                showEmptyState();
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
        }

        function renderDashboard(data) {
            document.getElementById('dashboardContent').style.display = 'block';
            
            renderStats(data.generalStats);
            renderDistributions(data.countryStats, data.deviceStats);
            renderDailyChart(data.dailyStats);
            renderUploadsTable(data.uploads);
        }

        function renderStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const totalStorage = formatBytes(stats.total_storage || 0);
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total_uploads || 0}</div>
                    <div class="stat-label">📁 Total Uploads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total_accesses || 0}</div>
                    <div class="stat-label">👁️ Total Accesos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.unique_visitors || 0}</div>
                    <div class="stat-label">👥 Visitantes Únicos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalStorage}</div>
                    <div class="stat-label">💾 Almacenamiento</div>
                </div>
            `;
        }

        function renderDistributions(countryStats, deviceStats) {
            const container = document.getElementById('distributionContainer');
            
            const countryHtml = countryStats.length > 0 ? 
                countryStats.slice(0, 5).map(item => `
                    <div class="distribution-item">
                        <span class="distribution-label">🌍 ${item.country || 'Desconocido'}</span>
                        <span class="distribution-value">${item.count}</span>
                    </div>
                `).join('') : 
                '<div class="distribution-item"><span class="distribution-label">Sin datos</span></div>';

            const deviceHtml = deviceStats.length > 0 ?
                deviceStats.map(item => `
                    <div class="distribution-item">
                        <span class="distribution-label">📱 ${getDeviceIcon(item.device_type)} ${item.device_type || 'Desconocido'}</span>
                        <span class="distribution-value">${item.count}</span>
                    </div>
                `).join('') :
                '<div class="distribution-item"><span class="distribution-label">Sin datos</span></div>';

            container.innerHTML = `
                <div class="distribution-card">
                    <div class="distribution-title">🌍 Por País</div>
                    ${countryHtml}
                </div>
                <div class="distribution-card">
                    <div class="distribution-title">📱 Por Dispositivo</div>
                    ${deviceHtml}
                </div>
            `;
        }

        function getDeviceIcon(deviceType) {
            switch(deviceType?.toLowerCase()) {
                case 'mobile': return '📱';
                case 'tablet': return '💿';
                case 'desktop': return '🖥️';
                default: return '📟';
            }
        }

        function renderDailyChart(dailyStats) {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (dailyChart) {
                dailyChart.destroy();
            }

            if (!dailyStats || dailyStats.length === 0) {
                ctx.canvas.parentElement.innerHTML = '<div class="chart-placeholder">📊 Sin datos de accesos aún</div>';
                return;
            }

            // Preparar datos (últimos 30 días)
            const last30Days = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                const dayData = dailyStats.find(d => d.date === dateStr);
                last30Days.push({
                    date: dateStr,
                    accesses: dayData ? dayData.accesses : 0,
                    unique_visitors: dayData ? dayData.unique_visitors : 0
                });
            }

            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last30Days.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Accesos Totales',
                        data: last30Days.map(d => d.accesses),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Visitantes Únicos',
                        data: last30Days.map(d => d.unique_visitors),
                        borderColor: '#764ba2',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderUploadsTable(uploads) {
            const tbody = document.getElementById('uploadsTableBody');
            
            if (uploads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            📭 No hay uploads aún
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = uploads.map(upload => {
                const createdDate = new Date(upload.created_at).toLocaleString('es-ES');
                const lastAccess = upload.last_access ? 
                    new Date(upload.last_access).toLocaleString('es-ES') : 
                    'Nunca';
                const totalSize = formatBytes(upload.total_size);

                return `
                    <tr class="upload-row">
                        <td>
                            <span class="upload-id">${upload.id.substring(0, 8)}...</span>
                        </td>
                        <td>
                            <span class="file-count">${upload.total_files} archivo${upload.total_files > 1 ? 's' : ''}</span>
                        </td>
                        <td>
                            <span class="size-cell">${totalSize}</span>
                        </td>
                        <td>
                            <span class="date-cell">${createdDate}</span>
                        </td>
                        <td>
                            <span class="access-count">${upload.total_accesses || 0}</span>
                        </td>
                        <td>
                            <span class="access-count">${upload.unique_visitors || 0}</span>
                        </td>
                        <td>
                            <span class="date-cell">${lastAccess}</span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="action-btn view-btn" onclick="viewUpload('${upload.id}')">
                                    👁️ Ver
                                </button>
                                <button class="action-btn qr-btn" onclick="downloadQR('${upload.id}')">
                                    📱 QR
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function viewUpload(uploadId) {
            window.open(`/share/${uploadId}`, '_blank');
        }

        function downloadQR(uploadId) {
            const link = document.createElement('a');
            link.href = `/api/qr/${uploadId}`;
            link.download = `qr-${uploadId}.png`;
            link.click();
        }

        function exportData() {
            const link = document.createElement('a');
            link.href = '/api/export/csv';
            link.download = 'access-logs.csv';
            link.click();
        }

        // Actualizar datos cada 5 minutos
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>